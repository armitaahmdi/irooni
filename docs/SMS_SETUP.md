# راهنمای تنظیم Kavenegar برای ارسال OTP و SMS

## مقدمه

پروژه از سرویس **Kavenegar** برای ارسال پیامک‌های OTP و سایر پیامک‌های سیستم استفاده می‌کند. Kavenegar یک سرویس معتبر و پرسرعت برای ارسال پیامک در ایران است.

## تنظیمات انجام شده

### 1. API Key
API Key در فایل `.env` باید تنظیم شود:
```env
KAVENEGAR_API_KEY=38584875732F344638347441337975694765435154686E5534336E6E736F4F67306B6649692B51627553343D
```

### 2. API Endpoints
از endpoint های زیر برای ارسال SMS استفاده می‌شود:

**متد Lookup (برای OTP - پیشنهادی):**
```
GET https://api.kavenegar.com/v1/{API-KEY}/verify/lookup.json
```

**متد Send (برای پیامک‌های عادی):**
```
GET https://api.kavenegar.com/v1/{API-KEY}/sms/send.json
```

### 3. نحوه کار

1. **تولید OTP**: یک کد 6 رقمی تصادفی تولید می‌شود
2. **ذخیره در دیتابیس**: OTP در جدول `verification_tokens` ذخیره می‌شود
3. **ارسال SMS**: با استفاده از Kavenegar API، پیامک ارسال می‌شود
   - در صورت وجود template، از متد **Lookup** استفاده می‌شود (اولویت بالا، بدون فیلتر)
   - در غیر این صورت از متد **Send** استفاده می‌شود
4. **تأیید OTP**: کاربر کد را وارد می‌کند و بررسی می‌شود

## تنظیمات Environment Variables

### متغیرهای اجباری
```env
# API Key کاوه‌نگار
KAVENEGAR_API_KEY=your-kavenegar-api-key
```

### متغیرهای اختیاری
```env
# نام الگوی OTP در پنل کاوه‌نگار
# در صورت تنظیم، از متد Lookup استفاده می‌شود
KAVENEGAR_TEMPLATE_NAME=myverification

# شماره فرستنده پیش‌فرض
# در صورت عدم تنظیم، از خط پیش‌فرض حساب استفاده می‌شود
KAVENEGAR_SENDER=10004346
```

## استفاده از متد Lookup (پیشنهادی)

متد Lookup برای ارسال OTP مناسب‌تر است زیرا:
- ✅ اولویت بالایی دارد
- ✅ فیلتر نمی‌شود (حتی اگر کاربر پیامک تبلیغاتی را بسته باشد)
- ✅ قابلیت ارسال به ۱۴۸ کشور
- ✅ نیاز به شماره فرستنده ندارد

### تنظیم Template در پنل کاوه‌نگار

1. وارد پنل کاوه‌نگار شوید: https://panel.kavenegar.com/
2. به بخش **الگوهای اعتبار سنجی** بروید
3. یک الگوی جدید ایجاد کنید
4. در متن الگو از `%token` برای جایگزینی کد OTP استفاده کنید

**مثال الگو:**
```
کد تأیید شما: %token
پوشاک ایرونی
این کد برای 5 دقیقه معتبر است.
```

5. پس از تأیید الگو، نام آن را در `.env` تنظیم کنید:
```env
KAVENEGAR_TEMPLATE_NAME=myverification
```

### استفاده از متد Send (بدون Template)

اگر template تنظیم نشده باشد، سیستم به صورت خودکار از متد Send استفاده می‌کند:

**فرمت پیامک:**
```
کد تأیید شما: 123456
پوشاک ایرونی
این کد برای 5 دقیقه معتبر است.
```

## تست

### در Development
- ✅ **SMS ارسال می‌شود** (همانند production)
- OTP در console نمایش داده می‌شود (برای راحتی تست)
- در صورت خطا، جزئیات خطا نمایش داده می‌شود

### در Production
- ✅ SMS ارسال می‌شود
- OTP در response برنمی‌گردد
- در صورت خطا، پیام خطای مناسب نمایش داده می‌شود

## خطاها و مدیریت آن‌ها

### خطاهای رایج

| کد خطا | توضیح | راه حل |
|--------|-------|--------|
| 401 | حساب کاربری غیرفعال است | حساب خود را در پنل فعال کنید |
| 403 | API Key معتبر نیست | API Key را بررسی کنید |
| 418 | اعتبار کافی نیست | حساب خود را شارژ کنید |
| 424 | الگوی مورد نظر پیدا نشد | نام template را بررسی کنید |
| 426 | نیاز به سرویس پیشرفته | سرویس پیشرفته را فعال کنید |
| 432 | پارامتر token در الگو پیدا نشد | الگو باید شامل `%token` باشد |

### مدیریت خطا در کد

اگر خطایی در ارسال SMS رخ دهد:
- OTP از دیتابیس حذف می‌شود
- خطای مناسب به کاربر نمایش داده می‌شود
- در development، جزئیات خطا در console نمایش داده می‌شود

## توابع موجود

### ارسال OTP
```javascript
import { sendOtp } from '@/lib/otp'

await sendOtp('09121234567')
```

### ارسال پیامک ساده
```javascript
import { sendSMS } from '@/utils/sms'

await sendSMS('09121234567', 'متن پیامک')
```

### ارسال پیامک سفارش
```javascript
import { sendOrderConfirmationSMS } from '@/utils/sms'

await sendOrderConfirmationSMS('09121234567', 'ORD-12345', 500000)
```

## نکات مهم

1. **اعتبار حساب**: مطمئن شوید که اعتبار حساب Kavenegar کافی است
2. **Template**: برای استفاده از متد Lookup، حتماً template را در پنل ایجاد کنید
3. **Rate Limiting**: Kavenegar محدودیت تعداد ارسال دارد (200 پیامک در هر فراخوانی)
4. **شماره فرستنده**: در صورت استفاده از متد Send، می‌توانید شماره فرستنده را تنظیم کنید
5. **تست**: قبل از استفاده در production، حتماً در محیط development تست کنید

## بررسی وضعیت پیامک

برای بررسی وضعیت پیامک ارسال شده:

```javascript
import { checkStatus } from '@/utils/kavenegar'

const result = await checkStatus(messageId)
console.log(result.statusText) // "رسیده به گیرنده"
```

## دریافت اطلاعات حساب

برای بررسی اعتبار باقی‌مانده:

```javascript
import { getAccountInfo } from '@/utils/kavenegar'

const info = await getAccountInfo()
console.log('اعتبار باقی‌مانده:', info.remainCredit, 'ریال')
```


## مستندات بیشتر

- مستندات کامل Kavenegar: https://kavenegar.com/rest.html
- پنل کاربری: https://panel.kavenegar.com/
- پشتیبانی: https://kavenegar.com/support
